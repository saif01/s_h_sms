import{c as K}from"./commonMixin-LD1l2-5e.js";import{_ as Y,A as M,d as S,w as l,a as o,r as u,b as s,f as p,t as r,c as _,e as b,E as Z,F as q,y as N,z as L,o as d}from"./app-CYStQJ0f.js";import{D as $}from"./DatePickerVuetifyInput-BRuyMDZm.js";import{a as W}from"./formatters-DzU97YYy.js";import{D as tt}from"./DatePicker-pwDn7i3L.js";import{P as et,p as st}from"./PaginationControls-CGFLaHsK.js";const at={name:"SaleDialog",mixins:[K],components:{DatePickerVuetifyInput:$},props:{modelValue:{type:Boolean,required:!0},sale:{type:Object,default:null}},emits:["update:modelValue","saved"],data(){return{form:this.getEmptyForm(),formValid:!1,cartItems:[],productSearch:"",searchResults:[],mostSoldProducts:[],customers:[],warehouses:[],saving:!1,paymentMethod:"cash",paymentMethods:[{title:"Cash",value:"cash"},{title:"Card",value:"card"},{title:"Mobile Banking",value:"mobile_banking"},{title:"Bank Transfer",value:"bank_transfer"},{title:"Cheque",value:"cheque"}],rules:{required:e=>!!e||"Required"},discountAmountManuallySet:!1}},computed:{isEdit(){return!!this.form.id},calculatedItemsDiscount(){return this.cartItems.reduce((e,t)=>e+(t.discount||0),0)},calculatedItemsTax(){return this.cartItems.reduce((e,t)=>e+(t.tax||0),0)},calculatedTotalTax(){return this.calculatedItemsTax}},watch:{sale:{immediate:!0,async handler(e){e&&e.id?await this.loadSaleForEdit(e.id):(this.form=this.getEmptyForm(),this.cartItems=[],this.discountAmountManuallySet=!1)}},modelValue(e){e?(this.fetchOptions(),this.fetchMostSoldProducts(),(!this.sale||!this.sale.id)&&(this.form=this.getEmptyForm(),this.cartItems=[],this.discountAmountManuallySet=!1)):(this.form=this.getEmptyForm(),this.cartItems=[],this.discountAmountManuallySet=!1)}},methods:{getEmptyForm(){return{id:null,invoice_number:null,customer_id:null,warehouse_id:null,invoice_date:new Date().toISOString().split("T")[0],due_date:null,status:"draft",subtotal:0,tax_amount:0,discount_amount:0,shipping_cost:0,total_amount:0,paid_amount:0,balance_amount:0,notes:""}},async fetchOptions(){try{const[e,t]=await Promise.all([M.get("/api/v1/customers"),M.get("/api/v1/warehouses")]);this.customers=e.data.data||e.data.customers||[],this.warehouses=t.data.data||t.data.warehouses||[]}catch(e){console.error("Failed to load options",e)}},async fetchMostSoldProducts(){try{const{data:e}=await M.get("/api/v1/products",{params:{per_page:10,is_active:1,sort:"most_sold",order:"desc"}});let t=e.data||e.products||[];if(t.length===0){const{data:h}=await M.get("/api/v1/products",{params:{per_page:10,is_active:1,has_stock:1}});t=h.data||h.products||[]}this.mostSoldProducts=t.filter(h=>h.stock_quantity>0).slice(0,10)}catch(e){console.error("Failed to load most sold products",e)}},async searchProducts(){if(this.productSearch)try{const{data:e}=await M.get("/api/v1/products",{params:{search:this.productSearch,per_page:10}});this.searchResults=e.data||e.products||[]}catch(e){console.error("Failed to search products",e)}},addToCart(e){const t=this.cartItems.findIndex(h=>h.product_id===e.id);if(t>=0)this.cartItems[t].quantity++,this.updateCartItem(t);else{const h=parseFloat(e.tax_rate||0);this.cartItems.push({product_id:e.id,product_name:e.name,quantity:1,unit_price:parseFloat(e.sale_price),discount:0,tax_rate:h,tax:0,total:0,notes:""}),this.updateCartItem(this.cartItems.length-1)}if(!this.form.warehouse_id&&e.stock_by_warehouse&&e.stock_by_warehouse.length>0){const h=e.stock_by_warehouse.filter(g=>g.quantity>0).sort((g,a)=>(a.quantity||0)-(g.quantity||0))[0];h&&h.warehouse_id?this.form.warehouse_id=h.warehouse_id:e.stock_by_warehouse[0]&&e.stock_by_warehouse[0].warehouse_id&&(this.form.warehouse_id=e.stock_by_warehouse[0].warehouse_id)}this.productSearch="",this.searchResults=[],this.calculateTotals()},updateCartItem(e,t=!1){const h=this.cartItems[e];if(!h)return;const a=h.quantity*h.unit_price-(h.discount||0);if(t)a>0&&h.tax>0&&(h.tax_rate=parseFloat((h.tax/a*100).toFixed(2)));else{const i=parseFloat(h.tax_rate||0);h.tax=parseFloat((a*i/100).toFixed(2))}h.total=parseFloat((a+h.tax).toFixed(2)),this.calculateTotals()},removeFromCart(e){this.cartItems.splice(e,1),this.calculateTotals()},calculateTotals(){const e=this.cartItems.reduce((c,v)=>c+v.quantity*v.unit_price,0),t=this.cartItems.reduce((c,v)=>c+(v.discount||0),0),h=this.cartItems.reduce((c,v)=>c+(v.tax||0),0);this.form.subtotal=parseFloat(e.toFixed(2));const g=this.form.discount_amount>0||this.form.discount_amount===0&&t===0?parseFloat(this.form.discount_amount):t,a=h,i=e-g+a+(parseFloat(this.form.shipping_cost)||0);this.form.total_amount=parseFloat(i.toFixed(2)),this.calculateBalance()},calculateBalance(){this.form.balance_amount=parseFloat((this.form.total_amount-(this.form.paid_amount||0)).toFixed(2))},getStatusLabel(e){return{draft:"Draft",pending:"Pending",partial:"Partial",paid:"Paid",cancelled:"Cancelled"}[e]||e},formatCurrency(e){return e==null||isNaN(e)?"0.00":parseFloat(e).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,",")},async loadSaleForEdit(e){var t,h,g;if(e)try{const i=(await M.get(`/api/v1/sales/${e}`)).data;if(!i){this.showError("Sale not found");return}if(console.log("Loading sale for edit:",i),this.form={id:i.id,invoice_number:i.invoice_number||null,customer_id:i.customer_id,warehouse_id:i.warehouse_id,invoice_date:i.invoice_date?i.invoice_date.includes("T")?i.invoice_date.split("T")[0]:i.invoice_date:new Date().toISOString().split("T")[0],due_date:i.due_date?i.due_date.includes("T")?i.due_date.split("T")[0]:i.due_date:null,status:i.status||"draft",subtotal:parseFloat(i.subtotal||0),tax_amount:parseFloat(i.tax_amount||0),discount_amount:parseFloat(i.discount_amount||0),shipping_cost:parseFloat(i.shipping_cost||0),total_amount:parseFloat(i.total_amount||0),paid_amount:parseFloat(i.paid_amount||0),balance_amount:parseFloat(i.balance_amount||0),notes:i.notes||""},i.payments&&Array.isArray(i.payments)&&i.payments.length>0){const c=i.payments.find(v=>v.payment_method)||i.payments[0];c&&c.payment_method&&(this.paymentMethod=c.payment_method)}this.discountAmountManuallySet=!0,i.items&&Array.isArray(i.items)&&i.items.length>0?this.cartItems=i.items.map(c=>{var z,C;const v=(c.quantity||0)*(c.unit_price||0),x=parseFloat(c.discount||0),n=v-x;let D=0;((z=c.product)==null?void 0:z.tax_rate)!==void 0?D=parseFloat(c.product.tax_rate||0):n>0&&(D=parseFloat(c.tax||0)/n*100);const I=parseFloat((n*D/100).toFixed(2)),P=parseFloat((n+I).toFixed(2));return{product_id:c.product_id,product_name:((C=c.product)==null?void 0:C.name)||"Unknown",quantity:parseInt(c.quantity,10),unit_price:parseFloat(c.unit_price||0),discount:x,tax_rate:D,tax:I,total:P,notes:c.notes||""}}):this.cartItems=[],this.calculateTotals()}catch(a){console.error("Failed to load sale for edit:",a),console.error("Error response:",(t=a.response)==null?void 0:t.data),this.showError(((g=(h=a.response)==null?void 0:h.data)==null?void 0:g.message)||"Failed to load sale details")}},showSuccess(e){window.Toast?window.Toast.fire({icon:"success",title:e}):window.Swal?window.Swal.fire({icon:"success",title:e,timer:2e3,showConfirmButton:!1}):alert(e)},showError(e){window.Toast?window.Toast.fire({icon:"error",title:e}):window.Swal?window.Swal.fire({icon:"error",title:e}):alert(e)},async save(e=null){var t,h,g;if(this.cartItems.length===0){this.showError("Please add at least one product");return}if(this.$refs.formRef){const{valid:a}=await this.$refs.formRef.validate();if(!a){this.showError("Please fill in all required fields");return}}if(!this.form.customer_id){this.showError("Please select a customer");return}if(!this.form.warehouse_id){this.showError("Please select a warehouse");return}if(!this.form.invoice_date){this.showError("Please select an invoice date");return}this.saving=!0;try{const a=this.cartItems.reduce((n,D)=>n+(D.discount||0),0),i=this.cartItems.reduce((n,D)=>n+(D.tax||0),0),c={customer_id:Number(this.form.customer_id),warehouse_id:Number(this.form.warehouse_id),invoice_date:this.form.invoice_date,due_date:this.form.due_date||null,paid_amount:parseFloat(this.form.paid_amount)||0,shipping_cost:parseFloat(this.form.shipping_cost)||0,notes:this.form.notes||"",payment_method:this.paymentMethod||"cash",items:this.cartItems.map(n=>({product_id:Number(n.product_id),quantity:parseInt(n.quantity,10),unit_price:parseFloat(n.unit_price),discount:parseFloat(n.discount)||0,tax:parseFloat(n.tax)||0,notes:n.notes||""}))},v=parseFloat(this.form.discount_amount)||0;(v>0||this.discountAmountManuallySet||v===0&&a===0)&&(c.discount_amount=v),e&&typeof e=="string"?c.status=String(e):this.isEdit&&this.form.status&&(c.status=String(this.form.status)),console.log("Saving sale with payload:",JSON.stringify(c,null,2));let x;this.isEdit?(x=await M.put(`/api/v1/sales/${this.form.id}`,c),this.showSuccess(e==="draft"?"Sale draft updated successfully":"Sale updated successfully")):(x=await M.post("/api/v1/sales",c),this.showSuccess(e==="draft"?"Sale saved as draft successfully":"Sale created successfully")),console.log("Sale saved successfully:",x.data),this.$emit("saved"),this.close()}catch(a){console.error("Failed to save sale:",a),console.error("Error response:",(t=a.response)==null?void 0:t.data),console.error("Error status:",(h=a.response)==null?void 0:h.status);let i="Failed to save sale. Please check the console for details.";(g=a.response)!=null&&g.data?a.response.data.message?i=a.response.data.message:a.response.data.error?i=a.response.data.error:a.response.data.errors&&(i=Object.values(a.response.data.errors).flat().join(", ")):a.message&&(i=a.message),this.showError(i)}finally{this.saving=!1}},async saveAsDraft(){await this.save("draft")},close(){this.$emit("update:modelValue",!1),this.form=this.getEmptyForm(),this.cartItems=[],this.searchResults=[],this.discountAmountManuallySet=!1}}},ot={class:"d-flex align-center gap-2"},it={class:"text-h6 text-white font-weight-medium"},lt={key:0,class:"mt-3"},nt={class:"text-caption text-grey mb-2"},rt={class:"d-flex flex-wrap gap-2"},dt={class:"ml-1 text-caption"},ct={key:1,class:"search-results-container"},ut={class:"text-body-2 font-weight-medium"},mt={class:"text-body-2"},pt={class:"pa-1"},ft={class:"text-body-2 font-weight-medium text-end"},ht={class:"text-body-2 font-weight-medium text-end"},_t={class:"text-body-2 font-weight-medium text-end"},vt={class:"text-body-2 font-weight-bold text-end"},yt={class:"text-center"},gt={class:"mb-2"},xt={class:"mb-2"},bt={key:0,class:"mb-2"},wt={key:1,class:"mb-2"},St={class:"totals-section"},kt={class:"d-flex justify-space-between mb-1"},Dt={class:"text-body-2 font-weight-medium"},Ft={key:0,class:"d-flex justify-space-between mb-1"},Ct={class:"text-body-2 text-error"},It={class:"d-flex justify-space-between mb-1"},Tt={key:1,class:"d-flex justify-space-between mb-1"},Vt={class:"text-body-2 font-weight-medium"},Pt={class:"d-flex justify-space-between mb-2"},zt={class:"d-flex justify-space-between mb-2 total-amount"},Et={class:"text-h6 font-weight-bold text-primary"},At={class:"mb-2"},Ut={class:"mb-2"},Mt={key:2,class:"mb-2"};function qt(e,t,h,g,a,i){const c=u("v-icon"),v=u("v-btn"),x=u("v-card-title"),n=u("v-text-field"),D=u("v-chip"),I=u("v-img"),P=u("v-avatar"),z=u("v-list-item-title"),C=u("v-list-item-subtitle"),w=u("v-list-item"),F=u("v-list"),E=u("v-card-text"),T=u("v-card"),y=u("v-divider"),A=u("v-table"),U=u("v-alert"),f=u("v-col"),k=u("v-autocomplete"),V=u("v-select"),B=u("DatePickerVuetifyInput"),O=u("v-row"),Q=u("v-textarea"),G=u("v-form"),J=u("v-card-actions"),X=u("v-dialog");return d(),S(X,{"model-value":h.modelValue,"onUpdate:modelValue":t[14]||(t[14]=m=>e.$emit("update:modelValue",m)),"max-width":"1400px",persistent:"",scrollable:""},{default:l(()=>[o(T,{class:"pos-dialog"},{default:l(()=>[o(x,{class:"pos-header d-flex justify-space-between align-center pa-3"},{default:l(()=>[s("div",ot,[o(c,{color:"white"},{default:l(()=>t[15]||(t[15]=[p("mdi-point-of-sale")])),_:1,__:[15]}),s("span",it,r(i.isEdit?"Edit Sale":"New Sale - POS"),1)]),o(v,{icon:"mdi-close",variant:"text",color:"white",size:"small",onClick:i.close},null,8,["onClick"])]),_:1}),o(E,{class:"pa-3"},{default:l(()=>[o(G,{ref:"formRef",modelValue:a.formValid,"onUpdate:modelValue":t[13]||(t[13]=m=>a.formValid=m)},{default:l(()=>[o(O,{dense:"",class:"ma-0"},{default:l(()=>[o(f,{cols:"12",lg:"8",class:"pa-2"},{default:l(()=>[o(T,{variant:"flat",class:"mb-3 search-card",elevation:"1"},{default:l(()=>[o(E,{class:"pa-3"},{default:l(()=>[o(n,{modelValue:a.productSearch,"onUpdate:modelValue":t[0]||(t[0]=m=>a.productSearch=m),label:"Search Product (Name/SKU/Barcode)","prepend-inner-icon":"mdi-magnify",clearable:"",autofocus:"",variant:"outlined","hide-details":"auto",hint:"Type product name, SKU, or barcode and press Enter to search","persistent-hint":"",onKeyup:Z(i.searchProducts,["enter"]),"onClick:clear":t[1]||(t[1]=m=>a.searchResults=[])},null,8,["modelValue","onKeyup"]),a.mostSoldProducts.length>0&&a.searchResults.length===0?(d(),_("div",lt,[s("div",nt,[o(c,{size:"14",class:"mr-1"},{default:l(()=>t[16]||(t[16]=[p("mdi-fire")])),_:1,__:[16]}),t[17]||(t[17]=p(" Most Sold Products "))]),s("div",rt,[(d(!0),_(q,null,N(a.mostSoldProducts,m=>(d(),S(D,{key:m.id,color:"primary",variant:"flat",size:"small",class:"product-chip",onClick:j=>i.addToCart(m),disabled:!m.stock_quantity||m.stock_quantity<=0},{default:l(()=>[o(c,{size:"14",class:"mr-1"},{default:l(()=>t[18]||(t[18]=[p("mdi-package-variant")])),_:1,__:[18]}),p(" "+r(m.name)+" ",1),s("span",dt,"(৳"+r(i.formatCurrency(m.sale_price))+")",1)]),_:2},1032,["onClick","disabled"]))),128))])])):b("",!0),a.searchResults.length>0?(d(),_("div",ct,[o(F,{class:"search-results"},{default:l(()=>[(d(!0),_(q,null,N(a.searchResults,m=>(d(),S(w,{key:m.id,onClick:j=>i.addToCart(m),class:"search-item"},{prepend:l(()=>[o(P,{size:"40",color:"grey-lighten-4"},{default:l(()=>[m.image?(d(),S(I,{key:0,src:m.image},null,8,["src"])):(d(),S(c,{key:1},{default:l(()=>t[19]||(t[19]=[p("mdi-package-variant")])),_:1,__:[19]}))]),_:2},1024)]),append:l(()=>[o(D,{color:"primary",size:"small",variant:"flat"},{default:l(()=>[p("৳"+r(i.formatCurrency(m.sale_price)),1)]),_:2},1024)]),default:l(()=>[o(z,null,{default:l(()=>[p(r(m.name),1)]),_:2},1024),o(C,null,{default:l(()=>[p(" SKU: "+r(m.sku||"N/A")+" | Stock: "+r(m.stock_quantity||0),1)]),_:2},1024)]),_:2},1032,["onClick"]))),128))]),_:1})])):b("",!0)]),_:1})]),_:1}),o(T,{variant:"flat",class:"cart-card",elevation:"1"},{default:l(()=>[o(x,{class:"cart-header pa-2"},{default:l(()=>[o(c,{size:"18",class:"mr-1"},{default:l(()=>t[20]||(t[20]=[p("mdi-cart")])),_:1,__:[20]}),s("span",ut,"Cart Items ("+r(a.cartItems.length)+")",1)]),_:1}),o(y),o(E,{class:"pa-2"},{default:l(()=>[a.cartItems.length>0?(d(),S(A,{key:0,density:"compact",class:"cart-table"},{default:l(()=>[t[21]||(t[21]=s("thead",null,[s("tr",null,[s("th",{class:"text-caption"},"Product"),s("th",{class:"text-caption text-center",style:{width:"70px"}},"Qty"),s("th",{class:"text-caption text-end",style:{width:"90px"}},"Price"),s("th",{class:"text-caption text-end",style:{width:"80px"}},"Disc."),s("th",{class:"text-caption text-end",style:{width:"80px"}},"Tax"),s("th",{class:"text-caption text-end",style:{width:"100px"}},"Total"),s("th",{class:"text-caption",style:{width:"40px"}})])],-1)),s("tbody",null,[(d(!0),_(q,null,N(a.cartItems,(m,j)=>(d(),_("tr",{key:j,class:"cart-row"},[s("td",mt,r(m.product_name),1),s("td",pt,[o(n,{modelValue:m.quantity,"onUpdate:modelValue":[R=>m.quantity=R,R=>i.updateCartItem(j)],modelModifiers:{number:!0},type:"number",min:"1",density:"compact","hide-details":"",variant:"outlined",class:"cart-input"},null,8,["modelValue","onUpdate:modelValue"])]),s("td",ft,"৳"+r(i.formatCurrency(m.unit_price||0)),1),s("td",ht,"৳"+r(i.formatCurrency(m.discount||0)),1),s("td",_t,"৳"+r(i.formatCurrency(m.tax||0)),1),s("td",vt,"৳"+r(i.formatCurrency(m.total)),1),s("td",yt,[o(v,{icon:"mdi-delete",size:"x-small",variant:"text",color:"error",onClick:R=>i.removeFromCart(j)},null,8,["onClick"])])]))),128))])]),_:1,__:[21]})):(d(),S(U,{key:1,type:"info",variant:"tonal",density:"compact",class:"mt-2 mb-0"},{default:l(()=>t[22]||(t[22]=[s("span",{class:"text-caption"},"Cart is empty. Search and add products.",-1)])),_:1,__:[22]}))]),_:1})]),_:1})]),_:1}),o(f,{cols:"12",lg:"4",class:"pa-2"},{default:l(()=>[o(T,{variant:"flat",class:"details-card",elevation:"1"},{default:l(()=>[o(E,{class:"pa-2"},{default:l(()=>[s("div",gt,[o(k,{modelValue:a.form.customer_id,"onUpdate:modelValue":t[2]||(t[2]=m=>a.form.customer_id=m),items:a.customers,"item-value":"id","item-title":"name",clearable:"",density:"compact",variant:"outlined","hide-details":"auto",rules:[a.rules.required],hint:"Select or search for a customer","persistent-hint":""},{"prepend-inner":l(()=>[o(c,{size:"18"},{default:l(()=>t[23]||(t[23]=[p("mdi-account")])),_:1,__:[23]})]),label:l(()=>t[24]||(t[24]=[p(" Customer "),s("span",{class:"text-error",style:{"font-size":"1.2em","font-weight":"bold"}},"*",-1)])),_:1},8,["modelValue","items","rules"])]),s("div",xt,[o(V,{modelValue:a.form.warehouse_id,"onUpdate:modelValue":t[3]||(t[3]=m=>a.form.warehouse_id=m),items:a.warehouses,"item-value":"id","item-title":"name",density:"compact",variant:"outlined","hide-details":"auto",rules:[a.rules.required],hint:"Select the warehouse for this sale","persistent-hint":""},{"prepend-inner":l(()=>[o(c,{size:"18"},{default:l(()=>t[25]||(t[25]=[p("mdi-warehouse")])),_:1,__:[25]})]),label:l(()=>t[26]||(t[26]=[p(" Warehouse "),s("span",{class:"text-error",style:{"font-size":"1.2em","font-weight":"bold"}},"*",-1)])),_:1},8,["modelValue","items","rules"])]),i.isEdit&&a.form.invoice_number?(d(),_("div",bt,[o(n,{"model-value":a.form.invoice_number,label:"Invoice Number",density:"compact",variant:"outlined",readonly:"","hide-details":"auto",hint:"Invoice number (auto-generated)","persistent-hint":""},{"prepend-inner":l(()=>[o(c,{size:"18"},{default:l(()=>t[27]||(t[27]=[p("mdi-receipt")])),_:1,__:[27]})]),_:1},8,["model-value"])])):b("",!0),i.isEdit&&a.form.status?(d(),_("div",wt,[o(n,{"model-value":i.getStatusLabel(a.form.status),label:"Status",density:"compact",variant:"outlined",readonly:"","hide-details":"auto",hint:"Current sale status","persistent-hint":""},{"prepend-inner":l(()=>[o(c,{size:"18"},{default:l(()=>t[28]||(t[28]=[p("mdi-information")])),_:1,__:[28]})]),_:1},8,["model-value"])])):b("",!0),o(O,{dense:"",class:"ma-0 mb-2"},{default:l(()=>[o(f,{cols:"6",class:"pa-1"},{default:l(()=>[o(B,{"field-label":"Invoice Date",required:"true",variant:"outlined","initial-date":a.form.invoice_date,onTrigerInputValue:t[4]||(t[4]=m=>{a.form.invoice_date=m})},null,8,["initial-date"]),t[29]||(t[29]=s("div",{class:"text-caption text-grey mt-1 ml-2"},[s("span",{class:"text-error",style:{"font-size":"1.1em","font-weight":"bold"}},"*"),p(" Select the invoice date ")],-1))]),_:1,__:[29]}),o(f,{cols:"6",class:"pa-1"},{default:l(()=>[o(B,{"field-label":"Due Date",variant:"outlined","initial-date":a.form.due_date,onTrigerInputValue:t[5]||(t[5]=m=>{a.form.due_date=m})},null,8,["initial-date"]),t[30]||(t[30]=s("div",{class:"text-caption text-grey mt-1 ml-2"}," Optional: Select payment due date ",-1))]),_:1,__:[30]})]),_:1}),o(y,{class:"my-2"}),s("div",St,[s("div",kt,[t[31]||(t[31]=s("span",{class:"text-caption text-grey"},"Subtotal:",-1)),s("span",Dt,"৳"+r(i.formatCurrency(a.form.subtotal)),1)]),i.calculatedItemsDiscount>0?(d(),_("div",Ft,[t[32]||(t[32]=s("span",{class:"text-caption text-grey"},"Item Discounts:",-1)),s("span",Ct,"-৳"+r(i.formatCurrency(i.calculatedItemsDiscount)),1)])):b("",!0),s("div",It,[t[33]||(t[33]=s("span",{class:"text-caption text-grey"},"Order Discount:",-1)),o(n,{modelValue:a.form.discount_amount,"onUpdate:modelValue":[t[6]||(t[6]=m=>a.form.discount_amount=m),t[7]||(t[7]=()=>{a.discountAmountManuallySet=!0,i.calculateTotals()})],modelModifiers:{number:!0},type:"number",density:"compact",variant:"outlined","hide-details":"",min:"0",step:"0.01",class:"compact-input"},null,8,["modelValue"])]),i.calculatedItemsTax>0?(d(),_("div",Tt,[t[34]||(t[34]=s("span",{class:"text-caption text-grey font-weight-medium"},"Total Tax:",-1)),s("span",Vt,"৳"+r(i.formatCurrency(i.calculatedItemsTax)),1)])):b("",!0),s("div",Pt,[t[35]||(t[35]=s("span",{class:"text-caption text-grey"},"Shipping:",-1)),o(n,{modelValue:a.form.shipping_cost,"onUpdate:modelValue":[t[8]||(t[8]=m=>a.form.shipping_cost=m),i.calculateTotals],modelModifiers:{number:!0},type:"number",density:"compact",variant:"outlined","hide-details":"",min:"0",step:"0.01",class:"compact-input"},null,8,["modelValue","onUpdate:modelValue"])]),o(y,{class:"my-2"}),s("div",zt,[t[36]||(t[36]=s("span",{class:"text-body-1 font-weight-bold"},"Total:",-1)),s("span",Et,"৳"+r(i.formatCurrency(a.form.total_amount)),1)]),s("div",At,[o(n,{modelValue:a.form.paid_amount,"onUpdate:modelValue":[t[9]||(t[9]=m=>a.form.paid_amount=m),i.calculateBalance],modelModifiers:{number:!0},type:"number",label:"Paid Amount",density:"compact",variant:"outlined",min:"0",step:"0.01","prepend-inner-icon":"mdi-cash","hide-details":"auto",hint:"Enter the amount paid by the customer (e.g., 1000.00)","persistent-hint":""},null,8,["modelValue","onUpdate:modelValue"])]),s("div",Ut,[o(n,{modelValue:a.form.balance_amount,"onUpdate:modelValue":t[10]||(t[10]=m=>a.form.balance_amount=m),modelModifiers:{number:!0},label:"Balance (Due)",density:"compact",variant:"outlined",readonly:"",color:a.form.balance_amount>0?"error":"success",class:L(a.form.balance_amount>0?"text-error":"text-success")},null,8,["modelValue","color","class"])]),a.form.paid_amount>0?(d(),_("div",Mt,[o(V,{modelValue:a.paymentMethod,"onUpdate:modelValue":t[11]||(t[11]=m=>a.paymentMethod=m),items:a.paymentMethods,label:"Payment Method",density:"compact",variant:"outlined","hide-details":"auto",hint:"Select how the customer paid","persistent-hint":""},null,8,["modelValue","items"])])):b("",!0)]),o(y,{class:"my-2"}),o(Q,{modelValue:a.form.notes,"onUpdate:modelValue":t[12]||(t[12]=m=>a.form.notes=m),label:"Notes",rows:"2",density:"compact",variant:"outlined","hide-details":"auto",hint:"Optional: Enter any additional notes or comments about this sale","persistent-hint":""},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1}),o(y),o(J,{class:"pa-2 justify-end"},{default:l(()=>[o(v,{variant:"text",size:"small",onClick:i.close},{default:l(()=>t[37]||(t[37]=[p("Cancel")])),_:1,__:[37]},8,["onClick"]),i.isEdit?b("",!0):(d(),S(v,{key:0,color:"grey",size:"small",loading:a.saving,disabled:a.cartItems.length===0,onClick:i.saveAsDraft},{default:l(()=>[o(c,{size:"18",class:"mr-1"},{default:l(()=>t[38]||(t[38]=[p("mdi-content-save-outline")])),_:1,__:[38]}),t[39]||(t[39]=p(" Save as Draft "))]),_:1,__:[39]},8,["loading","disabled","onClick"])),o(v,{color:"success",size:"small",loading:a.saving,disabled:a.cartItems.length===0,onClick:i.save},{default:l(()=>[o(c,{size:"18",class:"mr-1"},{default:l(()=>t[40]||(t[40]=[p("mdi-content-save")])),_:1,__:[40]}),p(" "+r(i.isEdit?"Update":"Save Sale"),1)]),_:1},8,["loading","disabled","onClick"])]),_:1})]),_:1})]),_:1},8,["model-value"])}const Nt=Y(at,[["render",qt],["__scopeId","data-v-5393da38"]]),H={async printInvoice(e,t){var h,g,a,i,c,v;try{const{data:x}=await M.get(`/api/v1/sales/${e.id}`),n=x.data||x.sale||x;if(!n){t&&t("Sale data not found");return}const D=window.open("","_blank","width=800,height=600");if(!D){t&&t("Please allow popups to print invoice");return}const I=(n.items||[]).reduce((k,V)=>k+parseFloat(V.discount||0),0),P=(n.items||[]).reduce((k,V)=>k+parseFloat(V.tax||0),0),z=parseFloat(n.subtotal||0),C=parseFloat(n.discount_amount||0),w=parseFloat(n.tax_amount||0),F=parseFloat(n.shipping_cost||0),E=C>0||C===0&&I===0?C:I;let T;w>0&&Math.abs(w-P)>=.01?T=w:T=Math.max(P,w);let y;n.total_amount!==void 0&&n.total_amount!==null?y=parseFloat(n.total_amount):y=z-E+T+F;const A=k=>k?new Date(k).toLocaleDateString("en-GB",{day:"2-digit",month:"2-digit",year:"numeric"}):"",f=`<!DOCTYPE html>
<html>
<head>
    <title>Invoice #${n.invoice_number}</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; padding: 20px; color: #000; }
        .invoice-container { max-width: 800px; margin: 0 auto; background: white; }
        .invoice-header { background: #1976d2; color: white; padding: 20px; text-align: center; }
        .invoice-header h1 { font-size: 24px; margin-bottom: 5px; }
        .invoice-header .invoice-number { font-size: 14px; opacity: 0.9; }
        .invoice-section { padding: 20px; border-bottom: 1px solid #ddd; }
        .invoice-row { display: flex; margin-bottom: 20px; }
        .invoice-col { flex: 1; }
        .invoice-col h3 { font-size: 14px; margin-bottom: 10px; color: #666; }
        .invoice-col p { margin: 3px 0; font-size: 13px; }
        .invoice-meta { display: flex; gap: 30px; margin-top: 15px; }
        .invoice-meta-item { flex: 1; }
        .invoice-meta-item label { font-size: 12px; color: #666; display: block; }
        .invoice-meta-item span { font-size: 14px; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th { background: #f5f5f5; padding: 10px; text-align: left; border: 1px solid #ddd; font-size: 12px; font-weight: bold; }
        td { padding: 10px; border: 1px solid #ddd; font-size: 12px; }
        .text-right { text-align: right; }
        .text-center { text-align: center; }
        .totals-box { background: #f9f9f9; padding: 15px; border: 2px solid #1976d2; margin-top: 20px; }
        .totals-row { display: flex; justify-content: space-between; padding: 5px 0; }
        .totals-row.total { border-top: 2px solid #1976d2; border-bottom: 2px solid #1976d2; padding: 10px 0; margin: 10px 0; background: rgba(25, 118, 210, 0.05); font-weight: bold; }
        .totals-row.balance { border-top: 1px dashed #999; padding-top: 10px; margin-top: 10px; font-weight: bold; }
        .invoice-footer { text-align: center; padding: 20px; color: #666; font-size: 12px; }
        .status-badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; text-transform: uppercase; }
        .status-draft { background: #9e9e9e; color: white; }
        .status-pending { background: #ff9800; color: white; }
        .status-partial { background: #2196f3; color: white; }
        .status-paid { background: #4caf50; color: white; }
        .status-cancelled { background: #f44336; color: white; }
        @media print {
            body { padding: 0; }
            .invoice-container { box-shadow: none; }
            @page { margin: 1.5cm; size: A4; }
        }
    </style>
</head>
<body>
    <div class="invoice-container">
        <div class="invoice-header">
            <h1>INVOICE</h1>
            <div class="invoice-number">#${n.invoice_number}</div>
        </div>

        <div class="invoice-section">
            <div class="invoice-row">
                <div class="invoice-col">
                    <h3>From</h3>
                    <p><strong>Your Company Name</strong></p>
                    <p>Company Address, City, State</p>
                    <p>Phone: +1234567890 | Email: info@company.com</p>
                </div>
                <div class="invoice-col">
                    <h3>Bill To</h3>
                    <p><strong>${((h=n.customer)==null?void 0:h.name)||"Walk-in Customer"}</strong></p>
                    ${(g=n.customer)!=null&&g.phone?`<p>Phone: ${n.customer.phone}</p>`:""}
                    ${(a=n.customer)!=null&&a.email?`<p>Email: ${n.customer.email}</p>`:""}
                    ${(i=n.customer)!=null&&i.address?`<p>${n.customer.address}</p>`:""}
                </div>
            </div>
            <div class="invoice-meta">
                <div class="invoice-meta-item">
                    <label>Invoice Date</label>
                    <span>${A(n.invoice_date)}</span>
                </div>
                ${n.due_date?`
                <div class="invoice-meta-item">
                    <label>Due Date</label>
                    <span>${A(n.due_date)}</span>
                </div>
                `:""}
                <div class="invoice-meta-item">
                    <label>Status</label>
                    <span class="status-badge status-${n.status||"pending"}">${(n.status||"pending").toUpperCase()}</span>
                </div>
            </div>
        </div>

        <div class="invoice-section">
            <h3 style="margin-bottom: 15px;">Items</h3>
            <table>
                <thead>
                    <tr>
                        <th style="width: 30px;">#</th>
                        <th>Product</th>
                        <th class="text-center" style="width: 60px;">Qty</th>
                        <th class="text-right" style="width: 90px;">Price</th>
                        <th class="text-right" style="width: 80px;">Disc.</th>
                        <th class="text-right" style="width: 80px;">Tax</th>
                        <th class="text-right" style="width: 100px;">Total</th>
                    </tr>
                </thead>
                <tbody>
                    ${(n.items||[]).map((k,V)=>{var B,O;return`
                    <tr>
                        <td>${V+1}</td>
                        <td>
                            <strong>${((B=k.product)==null?void 0:B.name)||"Unknown"}</strong>
                            ${(O=k.product)!=null&&O.sku?`<br><small style="color: #666;">SKU: ${k.product.sku}</small>`:""}
                        </td>
                        <td class="text-center">${k.quantity}</td>
                        <td class="text-right">৳${parseFloat(k.unit_price||0).toFixed(2)}</td>
                        <td class="text-right" style="color: #f44336;">-৳${parseFloat(k.discount||0).toFixed(2)}</td>
                        <td class="text-right">৳${parseFloat(k.tax||0).toFixed(2)}</td>
                        <td class="text-right"><strong>৳${parseFloat(k.total||0).toFixed(2)}</strong></td>
                    </tr>
                    `}).join("")}
                </tbody>
            </table>
        </div>

        <div class="invoice-section">
            <div class="invoice-row">
                <div class="invoice-col">
                    ${n.notes?`
                    <div style="background: #f9f9f9; padding: 10px; border-radius: 4px; margin-bottom: 15px;">
                        <h3 style="margin-bottom: 5px; font-size: 13px;">Notes</h3>
                        <p style="font-size: 12px;">${n.notes}</p>
                    </div>
                    `:""}
                    ${n.warehouse?`
                    <div style="background: #f9f9f9; padding: 10px; border-radius: 4px;">
                        <h3 style="margin-bottom: 5px; font-size: 13px;">Warehouse</h3>
                        <p style="font-size: 12px;">${n.warehouse.name}</p>
                    </div>
                    `:""}
                </div>
                <div class="invoice-col">
                    <div class="totals-box">
                        <div class="totals-row">
                            <span>Subtotal:</span>
                            <span>৳${z.toFixed(2)}</span>
                        </div>
                        ${I>0&&(!C||C===0)?`
                        <div class="totals-row">
                            <span>Item Discounts:</span>
                            <span style="color: #f44336;">-৳${I.toFixed(2)}</span>
                        </div>
                        `:""}
                        ${C>0?`
                        <div class="totals-row">
                            <span>Order Discount:</span>
                            <span style="color: #f44336;">-৳${C.toFixed(2)}</span>
                        </div>
                        `:""}
                        ${T>0?`
                        <div class="totals-row">
                            <span><strong>Total Tax:</strong></span>
                            <span><strong>৳${T.toFixed(2)}</strong></span>
                        </div>
                        `:""}
                        ${F>0?`
                        <div class="totals-row">
                            <span>Shipping:</span>
                            <span>৳${F.toFixed(2)}</span>
                        </div>
                        `:""}
                        <div class="totals-row total">
                            <span>Total:</span>
                            <span style="color: #1976d2;">৳${y.toFixed(2)}</span>
                        </div>
                        <div class="totals-row" style="color: #4caf50;">
                            <span><strong>Paid:</strong></span>
                            <span><strong>৳${parseFloat(n.paid_amount||0).toFixed(2)}</strong></span>
                        </div>
                        <div class="totals-row balance" style="color: ${n.balance_amount>0?"#f44336":"#4caf50"};">
                            <span><strong>Balance:</strong></span>
                            <span><strong>৳${parseFloat(n.balance_amount||0).toFixed(2)}</strong></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="invoice-footer">
            <p>Thank you for your business!</p>
        </div>
    </div>
    <script>
        window.onload = function() {
            window.print();
            window.onafterprint = function() {
                window.close();
            };
        };
    <\/script>
`+`</body>
</html>`;D.document.write(f),D.document.close()}catch(x){console.error("Failed to print invoice",x),t&&t(((v=(c=x.response)==null?void 0:c.data)==null?void 0:v.message)||"Failed to print invoice")}}},Bt={name:"ViewSaleDialog",props:{modelValue:{type:Boolean,required:!0},sale:{type:Object,default:null}},emits:["update:modelValue"],data(){return{saleData:null,loading:!1,currentSaleId:null}},watch:{modelValue:{immediate:!0,handler(e){e&&this.sale&&this.sale.id?this.currentSaleId!==this.sale.id&&this.loadSaleDetails(this.sale.id):e||(this.saleData=null,this.currentSaleId=null)}},sale:{immediate:!0,handler(e){e&&e.id&&this.modelValue&&this.currentSaleId!==e.id&&this.loadSaleDetails(e.id)}}},computed:{calculatedItemsDiscount(){return!this.saleData||!this.saleData.items?0:this.saleData.items.reduce((e,t)=>e+parseFloat(t.discount||0),0)},calculatedItemsTax(){return!this.saleData||!this.saleData.items?0:this.saleData.items.reduce((e,t)=>e+parseFloat(t.tax||0),0)},orderTaxAmount(){var e;return parseFloat(((e=this.saleData)==null?void 0:e.tax_amount)||0)},shouldShowOrderTax(){const e=this.calculatedItemsTax,t=this.orderTaxAmount;return t<=0?!1:!(e>0&&Math.abs(t-e)<.01)},calculatedTotalTax(){const e=this.calculatedItemsTax,t=this.orderTaxAmount;return t>0&&Math.abs(t-e)>=.01?t:Math.max(e,t)},calculatedTotalAmount(){if(!this.saleData)return 0;if(this.saleData.total_amount!==void 0&&this.saleData.total_amount!==null)return parseFloat(this.saleData.total_amount);const e=parseFloat(this.saleData.subtotal||0),t=parseFloat(this.saleData.discount_amount||0),h=parseFloat(this.saleData.shipping_cost||0),g=this.calculatedTotalTax,a=e-t+g+h;return parseFloat(a.toFixed(2))}},methods:{async loadSaleDetails(e){var t,h,g;if(!e){console.error("No sale ID provided");return}if(!(this.currentSaleId===e&&this.saleData)){this.currentSaleId=e,this.loading=!0,this.saleData=null;try{const{data:a}=await M.get(`/api/v1/sales/${e}`);this.saleData=a.data||a.sale||a,this.saleData||(this.showError("Sale data not found"),this.currentSaleId=null)}catch(a){console.error("Failed to load sale details:",a),console.error("Error response:",(t=a.response)==null?void 0:t.data),this.showError(((g=(h=a.response)==null?void 0:h.data)==null?void 0:g.message)||"Failed to load sale details"),this.currentSaleId=null}finally{this.loading=!1}}},formatDate:W,getStatusColor(e){return{draft:"grey",pending:"warning",partial:"info",paid:"success",cancelled:"error"}[e]||"grey"},printInvoice(){if(!this.sale||!this.sale.id){this.showError("Sale information not available");return}H.printInvoice(this.sale,e=>{this.showError(e)})},close(){this.$emit("update:modelValue",!1),this.saleData=null,this.currentSaleId=null},showError(e){window.Toast?window.Toast.fire({icon:"error",title:e}):window.Swal?window.Swal.fire({icon:"error",title:e}):alert(e)}}},Ot={class:"ribbon-text"},jt={class:"d-flex align-center gap-2"},Rt={key:0,class:"text-caption text-white text-opacity-90"},Lt={key:0,class:"text-center py-8"},Yt={key:1,class:"text-center py-8"},Kt={key:2,class:"invoice-content"},Wt={class:"invoice-header-section pa-3"},Ht={class:"invoice-customer-info"},Qt={class:"text-body-2 font-weight-medium mb-0"},Gt={key:0,class:"text-caption text-grey"},Jt={key:1,class:"text-caption text-grey"},Xt={key:2,class:"text-caption text-grey"},Zt={class:"invoice-dates-compact mt-2"},$t={class:"invoice-date-item"},te={class:"text-body-2 font-weight-medium"},ee={key:0,class:"invoice-date-item"},se={class:"text-body-2 font-weight-medium"},ae={class:"invoice-items-section pa-3"},oe={key:0},ie={class:"text-grey text-caption"},le={class:"text-body-2 font-weight-medium"},ne={key:0,class:"text-caption text-grey"},re={class:"text-center text-body-2"},de={class:"text-right text-body-2"},ce={class:"text-right text-body-2 text-error"},ue={class:"text-right text-body-2"},me={class:"text-right text-body-2 font-weight-bold"},pe={class:"invoice-totals-section pa-3"},fe={key:0,class:"invoice-notes"},he={class:"text-body-2 text-caption"},_e={key:1,class:"invoice-warehouse mt-2"},ve={class:"text-body-2 text-caption"},ye={class:"invoice-totals-box"},ge={class:"invoice-totals-row"},xe={class:"invoice-totals-value text-body-2"},be={key:0,class:"invoice-totals-row"},we={class:"invoice-totals-value text-body-2 text-error"},Se={key:1,class:"invoice-totals-row"},ke={class:"invoice-totals-value text-body-2 text-error"},De={key:2,class:"invoice-totals-row invoice-totals-highlight"},Fe={class:"invoice-totals-value text-body-2 font-weight-medium"},Ce={key:3,class:"invoice-totals-row"},Ie={class:"invoice-totals-value text-body-2"},Te={class:"invoice-totals-row invoice-totals-total"},Ve={class:"invoice-totals-value text-subtitle-1 font-weight-bold text-primary"},Pe={class:"invoice-totals-row invoice-totals-paid"},ze={class:"invoice-totals-value text-body-2 font-weight-medium text-success"},Ee={class:"invoice-totals-value text-body-2 font-weight-bold"};function Ae(e,t,h,g,a,i){const c=u("v-icon"),v=u("v-btn"),x=u("v-card-title"),n=u("v-progress-circular"),D=u("v-alert"),I=u("v-col"),P=u("v-row"),z=u("v-table"),C=u("v-divider"),w=u("v-card-text"),F=u("v-card-actions"),E=u("v-card"),T=u("v-dialog");return d(),S(T,{"model-value":h.modelValue,"onUpdate:modelValue":t[0]||(t[0]=y=>e.$emit("update:modelValue",y)),"max-width":"900px",persistent:"",scrollable:""},{default:l(()=>[o(E,{class:"invoice-card"},{default:l(()=>[a.saleData?(d(),_("div",{key:0,class:L(["status-ribbon",`status-ribbon-${a.saleData.status||"pending"}`])},[s("span",Ot,r((a.saleData.status||"pending").toUpperCase()),1)],2)):b("",!0),o(x,{class:"invoice-header d-flex justify-space-between align-center pa-3"},{default:l(()=>[s("div",jt,[o(c,{color:"white",size:"24"},{default:l(()=>t[1]||(t[1]=[p("mdi-file-document-outline")])),_:1,__:[1]}),s("div",null,[t[2]||(t[2]=s("div",{class:"text-h6 text-white font-weight-bold"},"INVOICE",-1)),a.saleData?(d(),_("div",Rt," #"+r(a.saleData.invoice_number),1)):b("",!0)])]),o(v,{icon:"mdi-close",variant:"text",color:"white",size:"small",onClick:i.close},null,8,["onClick"])]),_:1}),o(w,{class:"pa-0"},{default:l(()=>[a.loading?(d(),_("div",Lt,[o(n,{indeterminate:"",color:"primary",size:"48"}),t[3]||(t[3]=s("div",{class:"mt-3 text-body-2"},"Loading invoice details...",-1))])):a.saleData?(d(),_("div",Kt,[s("div",Wt,[o(P,{dense:""},{default:l(()=>[o(I,{cols:"12",md:"6"},{default:l(()=>t[5]||(t[5]=[s("div",{class:"invoice-company-info"},[s("div",{class:"text-subtitle-2 font-weight-bold mb-1"},"From"),s("div",{class:"text-body-2 font-weight-medium mb-0"},"Your Company Name"),s("div",{class:"text-caption text-grey"},"Company Address, City, State"),s("div",{class:"text-caption text-grey"},"Phone: +1234567890 | Email: info@company.com ")],-1)])),_:1,__:[5]}),o(I,{cols:"12",md:"6"},{default:l(()=>{var y,A,U,f;return[s("div",Ht,[t[6]||(t[6]=s("div",{class:"text-subtitle-2 font-weight-bold mb-1"},"Bill To",-1)),s("div",Qt,r(((y=a.saleData.customer)==null?void 0:y.name)||"Walk-in Customer"),1),(A=a.saleData.customer)!=null&&A.phone?(d(),_("div",Gt," Phone: "+r(a.saleData.customer.phone),1)):b("",!0),(U=a.saleData.customer)!=null&&U.email?(d(),_("div",Jt," Email: "+r(a.saleData.customer.email),1)):b("",!0),(f=a.saleData.customer)!=null&&f.address?(d(),_("div",Xt,r(a.saleData.customer.address),1)):b("",!0)])]}),_:1})]),_:1}),s("div",Zt,[s("div",$t,[o(c,{size:"16",class:"mr-1"},{default:l(()=>t[7]||(t[7]=[p("mdi-calendar")])),_:1,__:[7]}),t[8]||(t[8]=s("span",{class:"text-caption text-grey mr-1"},"Invoice:",-1)),s("span",te,r(i.formatDate(a.saleData.invoice_date)),1)]),a.saleData.due_date?(d(),_("div",ee,[o(c,{size:"16",class:"mr-1"},{default:l(()=>t[9]||(t[9]=[p("mdi-calendar-clock")])),_:1,__:[9]}),t[10]||(t[10]=s("span",{class:"text-caption text-grey mr-1"},"Due:",-1)),s("span",se,r(i.formatDate(a.saleData.due_date)),1)])):b("",!0)])]),s("div",ae,[t[13]||(t[13]=s("div",{class:"text-subtitle-1 font-weight-bold mb-2"},"Items",-1)),o(z,{class:"invoice-table",density:"compact"},{default:l(()=>[t[12]||(t[12]=s("thead",null,[s("tr",{class:"invoice-table-header"},[s("th",{class:"text-left",style:{width:"30px"}},"#"),s("th",{class:"text-left"},"Product"),s("th",{class:"text-center",style:{width:"60px"}},"Qty"),s("th",{class:"text-right",style:{width:"90px"}},"Price"),s("th",{class:"text-right",style:{width:"80px"}},"Disc."),s("th",{class:"text-right",style:{width:"80px"}},"Tax"),s("th",{class:"text-right",style:{width:"100px"}},"Total")])],-1)),s("tbody",null,[!a.saleData.items||a.saleData.items.length===0?(d(),_("tr",oe,t[11]||(t[11]=[s("td",{colspan:"7",class:"text-center py-4 text-grey"},"No items found",-1)]))):b("",!0),(d(!0),_(q,null,N(a.saleData.items||[],(y,A)=>{var U,f;return d(),_("tr",{key:y.id||y.product_id,class:"invoice-table-row"},[s("td",ie,r(A+1),1),s("td",null,[s("div",le,r(((U=y.product)==null?void 0:U.name)||"Unknown"),1),(f=y.product)!=null&&f.sku?(d(),_("div",ne,"SKU: "+r(y.product.sku),1)):b("",!0)]),s("td",re,r(y.quantity),1),s("td",de,"৳"+r(parseFloat(y.unit_price||0).toFixed(2)),1),s("td",ce,"-৳"+r(parseFloat(y.discount||0).toFixed(2)),1),s("td",ue,"৳"+r(parseFloat(y.tax||0).toFixed(2)),1),s("td",me,"৳"+r(parseFloat(y.total||0).toFixed(2)),1)])}),128))])]),_:1,__:[12]})]),s("div",pe,[o(P,{dense:""},{default:l(()=>[o(I,{cols:"12",md:"7"},{default:l(()=>[a.saleData.notes?(d(),_("div",fe,[t[14]||(t[14]=s("div",{class:"text-subtitle-2 font-weight-bold mb-1"},"Notes",-1)),s("div",he,r(a.saleData.notes),1)])):b("",!0),a.saleData.warehouse?(d(),_("div",_e,[t[15]||(t[15]=s("div",{class:"text-subtitle-2 font-weight-bold mb-1"},"Warehouse",-1)),s("div",ve,r(a.saleData.warehouse.name),1)])):b("",!0)]),_:1}),o(I,{cols:"12",md:"5"},{default:l(()=>[s("div",ye,[s("div",ge,[t[16]||(t[16]=s("span",{class:"invoice-totals-label text-caption"},"Subtotal:",-1)),s("span",xe,"৳"+r(parseFloat(a.saleData.subtotal||0).toFixed(2)),1)]),i.calculatedItemsDiscount>0&&(!a.saleData.discount_amount||a.saleData.discount_amount===0)?(d(),_("div",be,[t[17]||(t[17]=s("span",{class:"invoice-totals-label text-caption"},"Item Discounts:",-1)),s("span",we,"-৳"+r(i.calculatedItemsDiscount.toFixed(2)),1)])):b("",!0),a.saleData.discount_amount>0?(d(),_("div",Se,[t[18]||(t[18]=s("span",{class:"invoice-totals-label text-caption"},"Order Discount:",-1)),s("span",ke,"-৳"+r(parseFloat(a.saleData.discount_amount).toFixed(2)),1)])):b("",!0),i.calculatedTotalTax>0?(d(),_("div",De,[t[19]||(t[19]=s("span",{class:"invoice-totals-label text-body-2 font-weight-medium"},"Total Tax:",-1)),s("span",Fe,"৳"+r(i.calculatedTotalTax.toFixed(2)),1)])):b("",!0),a.saleData.shipping_cost>0?(d(),_("div",Ce,[t[20]||(t[20]=s("span",{class:"invoice-totals-label text-caption"},"Shipping:",-1)),s("span",Ie,"৳"+r(parseFloat(a.saleData.shipping_cost).toFixed(2)),1)])):b("",!0),o(C,{class:"my-2"}),s("div",Te,[t[21]||(t[21]=s("span",{class:"invoice-totals-label text-subtitle-1 font-weight-bold"},"Total:",-1)),s("span",Ve,"৳"+r(i.calculatedTotalAmount.toFixed(2)),1)]),s("div",Pe,[t[22]||(t[22]=s("span",{class:"invoice-totals-label text-body-2 font-weight-medium text-success"},"Paid:",-1)),s("span",ze,"৳"+r(parseFloat(a.saleData.paid_amount||0).toFixed(2)),1)]),s("div",{class:L(["invoice-totals-row invoice-totals-balance",a.saleData.balance_amount>0?"text-error":"text-success"])},[t[23]||(t[23]=s("span",{class:"invoice-totals-label text-body-2 font-weight-bold"},"Balance:",-1)),s("span",Ee,"৳"+r(parseFloat(a.saleData.balance_amount||0).toFixed(2)),1)],2)])]),_:1})]),_:1})]),t[24]||(t[24]=s("div",{class:"invoice-footer pa-2 text-center"},[s("div",{class:"text-caption text-grey"}," Thank you for your business! ")],-1))])):(d(),_("div",Yt,[o(D,{type:"error",variant:"tonal",class:"ma-3",density:"compact"},{default:l(()=>t[4]||(t[4]=[p(" Failed to load invoice details ")])),_:1,__:[4]})]))]),_:1}),o(C),o(F,{class:"justify-end pa-2 bg-grey-lighten-5"},{default:l(()=>[o(v,{color:"primary","prepend-icon":"mdi-printer",variant:"flat",size:"small",onClick:i.printInvoice},{default:l(()=>t[25]||(t[25]=[p(" Print Invoice ")])),_:1,__:[25]},8,["onClick"]),o(v,{variant:"text",size:"small",onClick:i.close},{default:l(()=>t[26]||(t[26]=[p("Close")])),_:1,__:[26]},8,["onClick"])]),_:1})]),_:1})]),_:1},8,["model-value"])}const Ue=Y(Bt,[["render",Ae],["__scopeId","data-v-bd68f24e"]]),Me={name:"AdminSales",mixins:[K,st],components:{SaleDialog:Nt,ViewSaleDialog:Ue,DatePicker:tt,PaginationControls:et},data(){return{sales:[],dialog:!1,viewDialog:!1,selectedSale:null,filters:{search:"",status:null,date_from:"",date_to:""},statusOptions:[{title:"Draft",value:"draft"},{title:"Pending",value:"pending"},{title:"Partial",value:"partial"},{title:"Paid",value:"paid"},{title:"Cancelled",value:"cancelled"}]}},async mounted(){await this.fetchSales()},methods:{async fetchSales(){try{this.loading=!0;const e=this.buildPaginationParams();this.perPage==="all"&&(e.per_page=999999),this.filters.search&&(e.search=this.filters.search),this.filters.status&&(e.status=this.filters.status),this.filters.date_from&&String(this.filters.date_from).trim()!==""&&(e.from_date=this.filters.date_from),this.filters.date_to&&String(this.filters.date_to).trim()!==""&&(e.to_date=this.filters.date_to);const t=await this.$axios.get("/api/v1/sales",{params:e,headers:this.getAuthHeaders()});this.sales=t.data.data||t.data.sales||[],this.updatePagination(t.data)}catch(e){this.handleApiError(e,"Failed to load sales")}finally{this.loading=!1}},openDialog(){this.selectedSale=null,this.dialog=!0},editSale(e){this.selectedSale=e,this.dialog=!0},viewSale(e){this.selectedSale=e,this.viewDialog=!0},async confirmDelete(e){if(confirm(`Are you sure you want to delete sale ${e.invoice_number}?`))try{await this.$axios.delete(`/api/v1/sales/${e.id}`,{headers:this.getAuthHeaders()}),this.showSuccess("Sale deleted successfully"),await this.fetchSales()}catch(t){this.handleApiError(t,"Error deleting sale")}},printInvoice(e){H.printInvoice(e,t=>{this.showError(t)})},handleSaved(){this.fetchSales()},resetFilters(){this.filters={search:"",status:null,date_from:"",date_to:""},this.resetPagination(),this.fetchSales()},onDateFromChange(e){this.filters.date_from=e||"",this.resetPagination(),this.fetchSales()},onDateToChange(e){this.filters.date_to=e||"",this.resetPagination(),this.fetchSales()},formatDateDDMMYYYY:W,getStatusColor(e){return{draft:"grey",pending:"warning",partial:"info",paid:"success",cancelled:"error"}[e]||"grey"},formatCurrency(e){return e==null||isNaN(e)?"0.00":parseFloat(e).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,",")}}},qe={class:"page-header"},Ne={class:"text-caption text-grey"},Be={class:"sortable-header"},Oe={class:"sortable-header"},je={class:"sortable-header justify-end"},Re={class:"sortable-header justify-end"},Le={class:"sortable-header justify-end"},Ye={class:"sortable-header"},Ke={class:"d-flex"},We={class:"font-weight-bold"},He={class:"text-end"},Qe={class:"text-end"},Ge={class:"text-end"},Je={key:0},Xe={class:"d-flex flex-column flex-md-row justify-space-between align-center align-md-start gap-3 mt-4"},Ze={class:"text-caption text-grey"},$e={key:0},ts={key:0},es={key:1},ss={key:1};function as(e,t,h,g,a,i){const c=u("v-btn"),v=u("v-select"),x=u("v-col"),n=u("DatePicker"),D=u("v-text-field"),I=u("v-row"),P=u("v-card-text"),z=u("v-card"),C=u("v-card-title"),w=u("v-icon"),F=u("v-skeleton-loader"),E=u("v-chip"),T=u("v-table"),y=u("PaginationControls"),A=u("SaleDialog"),U=u("ViewSaleDialog");return d(),_("div",null,[s("div",qe,[t[14]||(t[14]=s("h1",{class:"text-h4 page-title"},"Sales / POS",-1)),o(c,{color:"primary","prepend-icon":"mdi-plus",onClick:i.openDialog,class:"add-button"},{default:l(()=>t[13]||(t[13]=[p(" New Sale ")])),_:1,__:[13]},8,["onClick"])]),o(z,{class:"mb-4"},{default:l(()=>[o(P,null,{default:l(()=>[o(I,null,{default:l(()=>[o(x,{cols:"12",md:"3"},{default:l(()=>[o(v,{modelValue:a.filters.status,"onUpdate:modelValue":[t[0]||(t[0]=f=>a.filters.status=f),i.fetchSales],items:a.statusOptions,label:"Filter by Status","prepend-inner-icon":"mdi-filter",variant:"outlined",density:"compact",clearable:""},null,8,["modelValue","items","onUpdate:modelValue"])]),_:1}),o(x,{cols:"12",md:"3"},{default:l(()=>[o(n,{modelValue:a.filters.date_from,"onUpdate:modelValue":[t[1]||(t[1]=f=>a.filters.date_from=f),i.onDateFromChange],label:"From Date",density:"compact"},null,8,["modelValue","onUpdate:modelValue"])]),_:1}),o(x,{cols:"12",md:"3"},{default:l(()=>[o(n,{modelValue:a.filters.date_to,"onUpdate:modelValue":[t[2]||(t[2]=f=>a.filters.date_to=f),i.onDateToChange],label:"To Date",density:"compact"},null,8,["modelValue","onUpdate:modelValue"])]),_:1}),o(x,{cols:"12",md:"3"},{default:l(()=>[o(D,{modelValue:a.filters.search,"onUpdate:modelValue":t[3]||(t[3]=f=>a.filters.search=f),label:"Search Invoice/Customer","prepend-inner-icon":"mdi-magnify",variant:"outlined",density:"compact",clearable:"",onInput:i.fetchSales},null,8,["modelValue","onInput"])]),_:1})]),_:1})]),_:1})]),_:1}),o(z,null,{default:l(()=>[o(C,{class:"d-flex justify-space-between align-center"},{default:l(()=>[t[16]||(t[16]=s("span",null,"Sales",-1)),s("span",Ne,[t[15]||(t[15]=p(" Total Records: ")),s("strong",null,r((e.pagination.total||0).toLocaleString()),1)])]),_:1,__:[16]}),o(P,null,{default:l(()=>[o(T,null,{default:l(()=>[s("thead",null,[s("tr",null,[s("th",{class:"sortable",onClick:t[4]||(t[4]=f=>e.onSort("invoice_number"))},[s("div",Be,[t[18]||(t[18]=s("span",null,"Invoice #",-1)),e.sortBy==="invoice_number"?(d(),S(w,{key:0,size:"18",class:"sort-icon active"},{default:l(()=>[p(r(e.sortDirection==="asc"?"mdi-arrow-up":"mdi-arrow-down"),1)]),_:1})):(d(),S(w,{key:1,size:"18",class:"sort-icon inactive"},{default:l(()=>t[17]||(t[17]=[p(" mdi-unfold-more-horizontal ")])),_:1,__:[17]}))])]),t[29]||(t[29]=s("th",null,"Customer",-1)),s("th",{class:"sortable",onClick:t[5]||(t[5]=f=>e.onSort("invoice_date"))},[s("div",Oe,[t[20]||(t[20]=s("span",null,"Date",-1)),e.sortBy==="invoice_date"?(d(),S(w,{key:0,size:"18",class:"sort-icon active"},{default:l(()=>[p(r(e.sortDirection==="asc"?"mdi-arrow-up":"mdi-arrow-down"),1)]),_:1})):(d(),S(w,{key:1,size:"18",class:"sort-icon inactive"},{default:l(()=>t[19]||(t[19]=[p(" mdi-unfold-more-horizontal ")])),_:1,__:[19]}))])]),s("th",{class:"text-end sortable",onClick:t[6]||(t[6]=f=>e.onSort("total_amount"))},[s("div",je,[t[22]||(t[22]=s("span",null,"Total",-1)),e.sortBy==="total_amount"?(d(),S(w,{key:0,size:"18",class:"sort-icon active"},{default:l(()=>[p(r(e.sortDirection==="asc"?"mdi-arrow-up":"mdi-arrow-down"),1)]),_:1})):(d(),S(w,{key:1,size:"18",class:"sort-icon inactive"},{default:l(()=>t[21]||(t[21]=[p(" mdi-unfold-more-horizontal ")])),_:1,__:[21]}))])]),s("th",{class:"text-end sortable",onClick:t[7]||(t[7]=f=>e.onSort("paid_amount"))},[s("div",Re,[t[24]||(t[24]=s("span",null,"Paid",-1)),e.sortBy==="paid_amount"?(d(),S(w,{key:0,size:"18",class:"sort-icon active"},{default:l(()=>[p(r(e.sortDirection==="asc"?"mdi-arrow-up":"mdi-arrow-down"),1)]),_:1})):(d(),S(w,{key:1,size:"18",class:"sort-icon inactive"},{default:l(()=>t[23]||(t[23]=[p(" mdi-unfold-more-horizontal ")])),_:1,__:[23]}))])]),s("th",{class:"text-end sortable",onClick:t[8]||(t[8]=f=>e.onSort("balance_amount"))},[s("div",Le,[t[26]||(t[26]=s("span",null,"Due",-1)),e.sortBy==="balance_amount"?(d(),S(w,{key:0,size:"18",class:"sort-icon active"},{default:l(()=>[p(r(e.sortDirection==="asc"?"mdi-arrow-up":"mdi-arrow-down"),1)]),_:1})):(d(),S(w,{key:1,size:"18",class:"sort-icon inactive"},{default:l(()=>t[25]||(t[25]=[p(" mdi-unfold-more-horizontal ")])),_:1,__:[25]}))])]),s("th",{class:"sortable",onClick:t[9]||(t[9]=f=>e.onSort("status"))},[s("div",Ye,[t[28]||(t[28]=s("span",null,"Status",-1)),e.sortBy==="status"?(d(),S(w,{key:0,size:"18",class:"sort-icon active"},{default:l(()=>[p(r(e.sortDirection==="asc"?"mdi-arrow-up":"mdi-arrow-down"),1)]),_:1})):(d(),S(w,{key:1,size:"18",class:"sort-icon inactive"},{default:l(()=>t[27]||(t[27]=[p(" mdi-unfold-more-horizontal ")])),_:1,__:[27]}))])]),t[30]||(t[30]=s("th",null,"Actions",-1))])]),s("tbody",null,[e.loading?(d(),_(q,{key:0},N(5,f=>s("tr",{key:`skeleton-${f}`},[s("td",null,[o(F,{type:"text",width:"100"})]),s("td",null,[o(F,{type:"text",width:"120"})]),s("td",null,[o(F,{type:"text",width:"90"})]),s("td",null,[o(F,{type:"text",width:"80"})]),s("td",null,[o(F,{type:"text",width:"80"})]),s("td",null,[o(F,{type:"chip",width:"80",height:"24"})]),s("td",null,[o(F,{type:"chip",width:"80",height:"24"})]),s("td",null,[s("div",Ke,[o(F,{type:"button",width:"32",height:"32",class:"mr-1"}),o(F,{type:"button",width:"32",height:"32",class:"mr-1"}),o(F,{type:"button",width:"32",height:"32",class:"mr-1"}),o(F,{type:"button",width:"32",height:"32"})])])])),64)):(d(),_(q,{key:1},[(d(!0),_(q,null,N(a.sales,f=>{var k;return d(),_("tr",{key:f.id},[s("td",null,[s("span",We,r(f.invoice_number),1)]),s("td",null,r(((k=f.customer)==null?void 0:k.name)||"Walk-in"),1),s("td",null,r(i.formatDateDDMMYYYY(f.invoice_date)),1),s("td",He," ৳"+r(i.formatCurrency(f.total_amount)),1),s("td",Qe," ৳"+r(i.formatCurrency(f.paid_amount)),1),s("td",Ge,[o(E,{color:f.balance_amount>0?"error":"success",size:"small"},{default:l(()=>[p(" ৳"+r(i.formatCurrency(f.balance_amount)),1)]),_:2},1032,["color"])]),s("td",null,[o(E,{color:i.getStatusColor(f.status),size:"small"},{default:l(()=>[p(r(f.status),1)]),_:2},1032,["color"])]),s("td",null,[o(c,{icon:"mdi-eye",size:"small",variant:"text",onClick:V=>i.viewSale(f)},null,8,["onClick"]),o(c,{icon:"mdi-pencil",size:"small",variant:"text",onClick:V=>i.editSale(f)},null,8,["onClick"]),o(c,{icon:"mdi-printer",size:"small",variant:"text",onClick:V=>i.printInvoice(f)},null,8,["onClick"]),o(c,{icon:"mdi-delete",size:"small",variant:"text",color:"error",onClick:V=>i.confirmDelete(f)},null,8,["onClick"])])])}),128)),a.sales.length===0?(d(),_("tr",Je,t[31]||(t[31]=[s("td",{colspan:"8",class:"text-center py-4"},"No sales found",-1)]))):b("",!0)],64))])]),_:1}),s("div",Xe,[s("div",Ze,[a.sales.length>0&&e.pagination.total>0?(d(),_("span",$e,[e.perPage==="all"?(d(),_("span",ts,[t[32]||(t[32]=p(" Showing ")),s("strong",null,"all "+r(e.pagination.total.toLocaleString()),1),t[33]||(t[33]=p(" records "))])):(d(),_("span",es,[t[34]||(t[34]=p(" Showing ")),s("strong",null,r((e.currentPage-1)*e.perPage+1),1),t[35]||(t[35]=p(" to ")),s("strong",null,r(Math.min(e.currentPage*e.perPage,e.pagination.total).toLocaleString()),1),t[36]||(t[36]=p(" of ")),s("strong",null,r(e.pagination.total.toLocaleString()),1),t[37]||(t[37]=p(" records "))]))])):(d(),_("span",ss,"No records found"))]),o(y,{modelValue:e.currentPage,"onUpdate:modelValue":t[10]||(t[10]=f=>e.currentPage=f),pagination:e.pagination,"per-page-value":e.perPage,"per-page-options":e.perPageOptions,"onUpdate:perPage":e.onPerPageUpdate,onPageChange:e.onPageChange},null,8,["modelValue","pagination","per-page-value","per-page-options","onUpdate:perPage","onPageChange"])])]),_:1})]),_:1}),o(A,{"model-value":a.dialog,"onUpdate:modelValue":t[11]||(t[11]=f=>a.dialog=f),sale:a.selectedSale,onSaved:i.handleSaved},null,8,["model-value","sale","onSaved"]),o(U,{"model-value":a.viewDialog,"onUpdate:modelValue":t[12]||(t[12]=f=>a.viewDialog=f),sale:a.selectedSale},null,8,["model-value","sale"])])}const cs=Y(Me,[["render",as],["__scopeId","data-v-9d020d5a"]]);export{cs as default};
